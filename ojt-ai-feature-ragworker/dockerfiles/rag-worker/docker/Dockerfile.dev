FROM debian:12-slim

ENV DEBIAN_FRONTEND=noninteractive
ENV VCPKG_ROOT=/opt/vcpkg
ENV PATH="${VCPKG_ROOT}:${PATH}"

# Install base build tools and dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential cmake pkg-config git curl ca-certificates \
    libssl-dev libcurl4-openssl-dev \
    libpq-dev libpqxx-dev \
    librdkafka-dev \
    nlohmann-json3-dev \
    python3 python3-pip \
    zip \
    && rm -rf /var/lib/apt/lists/*

# Install mc for MinIO ops
RUN curl -sL https://dl.min.io/client/mc/release/linux-amd64/mc -o /usr/local/bin/mc \
    && chmod +x /usr/local/bin/mc

# Copy and run the SDK installation script
COPY dockerfiles/rag-worker/docker/install_cpp_sdks.sh /usr/local/bin/install_cpp_sdks.sh
RUN sed -i 's/\r$//' /usr/local/bin/install_cpp_sdks.sh && \
    chmod +x /usr/local/bin/install_cpp_sdks.sh && \
    bash /usr/local/bin/install_cpp_sdks.sh

# Copy source and build rag-worker
COPY workspace/rag-worker/rag-worker /app/rag-worker
WORKDIR /app/rag-worker

# Robust out-of-source build to avoid in-source CMake cache issues
RUN rm -rf build && \
    cmake -S . -B build \
      -DCMAKE_BUILD_TYPE=Release \
      -DCMAKE_TOOLCHAIN_FILE=/opt/vcpkg/scripts/buildsystems/vcpkg.cmake \
      -DVCPKG_TARGET_TRIPLET=x64-linux \
    && \
    cmake --build build -j$(nproc) && \
    ls -lh build/rag-worker-dev && \
    install -Dm755 build/rag-worker-dev /usr/local/bin/rag-worker-dev && \
    echo "[Dockerfile] rag-worker-dev built successfully"

# Set working directory for runtime
WORKDIR /app

CMD ["/bin/bash"]
